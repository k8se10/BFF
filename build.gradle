plugins {
    id 'fabric-loom' version '1.6.12'
    id 'maven-publish'
}

group = 'net.mod.buildcraft.fabric'
version = System.getenv("BUILD_VERSION") ?: "0.1.0-SNAPSHOT"

base {
    archivesName = 'buildcraft-fabric'
}

repositories {
    // Put Maven Central first to avoid TLS quirks elsewhere
    mavenCentral()
    maven { url = 'https://maven.fabricmc.net/' }
    maven { url = 'https://maven.quiltmc.org/repository/release/' }
    maven { url = 'https://maven.ladysnake.org/releases' }
    maven { url = 'https://maven.terraformersmc.com/releases/' }
    maven { url = 'https://repo.spongepowered.org/repository/maven-public/' }
}

dependencies {
    minecraft "com.mojang:minecraft:1.20.4"
    mappings loom.officialMojangMappings()

    modImplementation "net.fabricmc:fabric-loader:0.15.11"
    modImplementation "net.fabricmc.fabric-api:fabric-api:0.97.8+1.20.4"

    // MixinExtras from Maven Central (avoid Fabric maven TLS issue)
    modImplementation("io.github.llamalad7:mixinextras-fabric:0.3.5")
    annotationProcessor("io.github.llamalad7:mixinextras-fabric:0.3.5")
}

loom {
    splitEnvironmentSourceSets()
    runs {
        client {
            client()
            ideConfigGenerated(true)
            setConfigName("Fabric Client")
        }
        server {
            server()
            ideConfigGenerated(true)
            setConfigName("Fabric Server")
        }
    }
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
    withSourcesJar()
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
    options.release = 17
}

// Ensure a remapped, game-ready jar is produced on build
tasks.named("build") {
    dependsOn("remapJar")
}

// Minimal publishing stub (optional; safe to keep)
publishing {
    publications {
        create("mavenJava", MavenPublication) {
            from components.java
        }
    }
    repositories {
        mavenLocal()
    }
}
